(()=>{if(window.LumifyWidget&&window.LumifyWidget._initialized)console.warn("LumifyWidget: Already initialized");else{let t={mode:"floating",position:"bottom-right",theme:"auto",accentColor:"#6366f1",buttonText:"",buttonIcon:"search",placeholder:"Ask anything...",keyboardShortcut:!0,showBranding:!0,zIndex:9999,emptyText:"Ask a question to get started",modalTitle:"Search",apiEndpoint:"/api/v1/search.php",answerMode:!0,similarQuestions:!1,ctaTarget:"_self",popularQuestions:{enabled:!1,maxDisplay:5,cacheStrategy:"localStorage",cacheTTL:86400,fallback:[]}},r={search:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>',chat:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',help:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>',close:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',send:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>',loading:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/></path></svg>'};class s{constructor(e){this.config={...t,...e},this.config.popularQuestions={...t.popularQuestions,...e.popularQuestions},this.baseUrl=e.baseUrl||"",this.isOpen=!1,this.isLoading=!1,this.currentSearch=null,this.elements={},this._popularQuestionsData=null,this._popularQuestionsVisible=!1,this._init()}_init(){switch(this._injectStyles(),this._applyTheme(),this.config.mode){case"inline":this._createInlineUI();break;case"trigger":this._createTriggerUI();break;default:this._createFloatingUI()}this.config.keyboardShortcut&&"inline"!==this.config.mode&&this._bindKeyboardShortcut(),"auto"===this.config.theme&&this._watchThemeChanges()}_injectStyles(){var e;document.getElementById("lumify-widget-styles")||((e=document.createElement("style")).id="lumify-widget-styles",e.textContent=i(this.config),document.head.appendChild(e))}_applyTheme(){var e="auto"===this.config.theme?window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":this.config.theme;this.currentTheme=e}_watchThemeChanges(){window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{this.currentTheme=e.matches?"dark":"light",this._updateThemeClass()})}_updateThemeClass(){document.querySelectorAll(".lumify-widget-root, .lumify-widget-modal").forEach(e=>{e.classList.remove("lw-theme-light","lw-theme-dark"),e.classList.add("lw-theme-"+this.currentTheme)})}_createFloatingUI(){var e=document.createElement("div"),t=(e.className="lumify-widget-root lw-theme-"+this.currentTheme,document.createElement("button")),i=(t.className="lumify-widget-button lw-"+this.config.position,t.setAttribute("aria-label","Open search"),t.setAttribute("type","button"),"none"!==this.config.buttonIcon&&(t.innerHTML=r[this.config.buttonIcon]||r.search),this.config.buttonText?((i=document.createElement("span")).className="lw-button-text",i.textContent=this.config.buttonText,t.appendChild(i)):t.classList.add("lw-icon-only"),t.addEventListener("click",()=>this.open()),document.createElement("div")),o=(i.className="lumify-widget-overlay",i.addEventListener("click",()=>this.close()),this._createModal());this.elements.root=e,this.elements.button=t,this.elements.overlay=i,this.elements.modal=o,e.appendChild(t),e.appendChild(i),e.appendChild(o),document.body.appendChild(e)}_createInlineUI(){var e,t,i,o=this.config.containerSelector?document.querySelector(this.config.containerSelector):this._findScriptParent();o?((e=document.createElement("div")).className="lumify-widget-root lumify-widget-inline lw-theme-"+this.currentTheme,t=this._createSearchForm(),(i=document.createElement("div")).className="lumify-widget-results",i.innerHTML=this._getEmptyState(),this.elements.root=e,this.elements.results=i,e.appendChild(t),e.appendChild(i),o.appendChild(e),this.config.popularQuestions.enabled&&this._initPopularQuestions()):console.error("LumifyWidget: Container not found for inline mode")}_createTriggerUI(){var e,t,i,o=document.querySelector(this.config.triggerSelector);o?((e=document.createElement("div")).className="lumify-widget-root lw-theme-"+this.currentTheme,(t=document.createElement("div")).className="lumify-widget-overlay",t.addEventListener("click",()=>this.close()),i=this._createModal(),this.elements.root=e,this.elements.overlay=t,this.elements.modal=i,o.addEventListener("click",e=>{e.preventDefault(),this.open()}),e.appendChild(t),e.appendChild(i),document.body.appendChild(e)):console.error("LumifyWidget: Trigger element not found:",this.config.triggerSelector)}_createModal(){var e=document.createElement("div"),t=(e.className="lumify-widget-modal lumify-widget-root lw-theme-"+this.currentTheme,e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-label","Search"),document.createElement("div")),i=(t.className="lumify-widget-header",document.createElement("span")),o=(i.className="lumify-widget-title",i.textContent=this.config.modalTitle,this.config.keyboardShortcut?((o=document.createElement("span")).className="lumify-widget-shortcut",o.textContent=n(),t.appendChild(i),t.appendChild(o)):t.appendChild(i),document.createElement("button")),i=(o.className="lumify-widget-close",o.setAttribute("aria-label","Close"),o.setAttribute("type","button"),o.innerHTML=r.close,o.addEventListener("click",()=>this.close()),t.appendChild(o),this._createSearchForm()),o=document.createElement("div"),a=(o.className="lumify-widget-results",o.innerHTML=this._getEmptyState(),this._createFooter());return this.elements.results=o,e.appendChild(t),e.appendChild(i),e.appendChild(o),a&&e.appendChild(a),e}_createSearchForm(){var e=document.createElement("form");e.className="lumify-widget-search",e.addEventListener("submit",e=>{e.preventDefault(),this._performSearch()});let t=document.createElement("input");t.type="text",t.className="lumify-widget-input",t.placeholder=this.config.placeholder,t.setAttribute("autocomplete","off"),t.setAttribute("maxlength","500"),this.config.popularQuestions.enabled&&(t.addEventListener("input",()=>{0<t.value.trim().length&&this._hidePopularQuestions()}),t.addEventListener("focus",()=>{!t.value.trim()&&0<this._popularQuestionsData?.length&&this._showPopularQuestions()}));var i=document.createElement("button");return i.type="submit",i.className="lumify-widget-submit",i.setAttribute("aria-label","Search"),i.innerHTML=r.send,this.elements.input=t,this.elements.submit=i,e.appendChild(t),e.appendChild(i),e}_createFooter(){var e,t;return this.config.showBranding?((e=document.createElement("div")).className="lumify-widget-footer",(t=document.createElement("a")).className="lumify-widget-branding",t.href="https://www.lumify.ai?ref=widget",t.target="_blank",t.rel="noopener",t.innerHTML='Powered by <span class="lumify-widget-branding-link">Lumify</span>',e.appendChild(t),e):null}_getEmptyState(){let e=`
                <div class="lumify-widget-empty">
                    <div class="lumify-widget-empty-icon">${r.search}</div>
                    <div class="lumify-widget-empty-text">${this.config.emptyText}</div>
                </div>
            `;return this.config.popularQuestions.enabled&&(e+=`
                    <div class="lumify-widget-popular lw-hidden">
                        <div class="lumify-widget-popular-header">Popular questions:</div>
                        <ul class="lumify-widget-popular-list"></ul>
                    </div>
                `),e}_findScriptParent(){var e=document.querySelectorAll('script[src*="lumify-widget"]');return 0<e.length?e[e.length-1].parentElement:document.body}_bindKeyboardShortcut(){document.addEventListener("keydown",e=>{(e.metaKey||e.ctrlKey)&&"k"===e.key&&(e.preventDefault(),this.isOpen?this.close():this.open()),"Escape"===e.key&&this.isOpen&&this.close()})}open(){this.isOpen||"inline"===this.config.mode||(this.isOpen=!0,this.elements.overlay&&this.elements.overlay.classList.add("lw-open"),this.elements.modal&&this.elements.modal.classList.add("lw-open"),setTimeout(()=>{this.elements.input&&this.elements.input.focus()},100),this.config.popularQuestions.enabled&&!this._popularQuestionsData?this._initPopularQuestions():this._popularQuestionsData&&!this.elements.input?.value.trim()&&this._showPopularQuestions(),document.body.style.overflow="hidden")}close(){this.isOpen&&(this.isOpen=!1,this.elements.overlay&&this.elements.overlay.classList.remove("lw-open"),this.elements.modal&&this.elements.modal.classList.remove("lw-open"),document.body.style.overflow="")}async _performSearch(){var e=this.elements.input?.value.trim();if(e){this.currentSearch&&this.currentSearch.abort(),this.isLoading=!0,this._showLoading();var t=new AbortController;this.currentSearch=t;try{var i=await fetch(this.config.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.config.apiKey},body:JSON.stringify({query:e,application_id:this.config.appId,answer_mode:this.config.answerMode,similar_questions:this.config.similarQuestions}),signal:t.signal});if(!i.ok){if(401===i.status||403===i.status)throw new Error("AUTH_ERROR");throw new Error("HTTP "+i.status)}var o=await i.json();this._displayResults(o)}catch(e){"AbortError"!==e.name&&this._displayError(e.message)}finally{this.isLoading=!1,this.currentSearch=null}}}_showLoading(){this.elements.results&&(this.elements.results.innerHTML=`
                    <div class="lumify-widget-loading">
                        ${r.loading}
                        <span>Thinking...</span>
                    </div>
                `),this.elements.submit&&(this.elements.submit.disabled=!0,this.elements.submit.innerHTML=r.loading)}_displayResults(t){if(this.elements.submit&&(this.elements.submit.disabled=!1,this.elements.submit.innerHTML=r.send),this.elements.results)if(t.success){let e="";var i,o=t.metadata?.link_target||this.config.ctaTarget||"_self";t.direct_answer?.answer&&(i=t.direct_answer.sources||[],i=((e,o,r)=>{if(!e)return"";let n=[],i=(e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,t,i)=>{var o=`__LINK_PLACEHOLDER_${n.length}__`,a="_blank"===r?' rel="noopener noreferrer"':"";return n.push(`<a href="${l(i)}" target="${r}"${a}>${l(t)}</a>`),o}),l(e).replace(/\n/g,"<br>"));return n.forEach((e,t)=>{i=i.replace(`__LINK_PLACEHOLDER_${t}__`,e)}),i=o&&0<o.length?i.replace(/\[(\d+)\]/g,(e,t)=>{var i=parseInt(t,10)-1;return 0<=i&&i<o.length?a(t,o[i],r):e}):i})(t.direct_answer.answer,i,o),e+=`<div class="lumify-widget-answer">${i}</div>`,t.direct_answer?.cta&&(i=t.direct_answer.cta,e+=this._renderCTA(i,o)),t.confidence_score)&&(e+=`<div class="lumify-widget-confidence">Confidence: ${Math.round(100*t.confidence_score)}%</div>`),t.direct_answer?.answer||(t.no_results?e+=`<div class="lumify-widget-no-results">${l(t.no_results.message||"No results found.")}</div>`:e+='<div class="lumify-widget-no-results">No results found for your search.</div>'),this.elements.results.innerHTML=e,this._initCitationTooltips()}else this._displayError(t.error?.message||t.error||"Search failed")}_initCitationTooltips(){let n=this.elements.results;n&&n.querySelectorAll(".lumify-widget-citation").forEach(a=>{let r=a.querySelector(".lumify-widget-citation-tooltip");r&&a.addEventListener("mouseenter",()=>{r.style.left="50%",r.style.right="",r.style.top="",r.style.bottom="",r.style.transform="translateX(-50%)",r.classList.remove("tooltip-above"),requestAnimationFrame(()=>{var e=r.getBoundingClientRect(),t=(a.getBoundingClientRect(),n.getBoundingClientRect()),i=this.elements.modal?this.elements.modal.getBoundingClientRect():t;let o="-50%";var t=Math.min(t.bottom,i.bottom-60);e.bottom>t&&(r.style.top="auto",r.style.bottom="calc(100% + 8px)",r.classList.add("tooltip-above")),e.left<i.left+12?(t=i.left+12-e.left,o=`calc(-50% + ${t}px)`):e.right>i.right-12&&(t=e.right-(i.right-12),o=`calc(-50% - ${t}px)`),r.style.transform=`translateX(${o})`})})})}_renderCTA(e,t="_self"){var i,o,a;return e&&e.url&&e.text?(i=l(e.text),a=l(e.url),o=l(e.title||e.text),`
                <div class="lumify-widget-cta">
                    <a href="${a}" 
                       target="${a=e.target||t||this.config.ctaTarget||"_self"}" 
                       ${"_blank"===a?'rel="noopener noreferrer"':""}
                       class="lumify-widget-cta-link"
                       title="${o}">
                        <span class="lumify-widget-cta-text">${i}</span>
                        <span class="lumify-widget-cta-badge" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </span>
                    </a>
                </div>
            `):""}_displayError(e){this.elements.submit&&(this.elements.submit.disabled=!1,this.elements.submit.innerHTML=r.send),this.elements.results&&(this.elements.results.innerHTML="AUTH_ERROR"===e?`
                    <div class="lumify-widget-error">
                        <strong>Authentication Error:</strong> API credentials not recognized.
                        <br><br>
                        <small>Visit <a href="https://www.lumify.ai" target="_blank" rel="noopener">lumify.ai</a> to get your API keys.</small>
                    </div>
                `:`
                    <div class="lumify-widget-error">
                        Search failed: ${l(e)}
                        <br><br>
                        <small>Please try again or contact support if the problem persists.</small>
                    </div>
                `)}search(e){this.elements.input&&(this.elements.input.value=e),this._performSearch()}async _initPopularQuestions(){var e;this.config.popularQuestions.enabled&&(e=await this._loadPopularQuestions())&&0<e.length&&(this._renderPopularQuestions(e),this._showPopularQuestions())}async _loadPopularQuestions(){var e=this._getCachedPopularQuestions();if(e)return this._popularQuestionsData=e;0<this.config.popularQuestions.fallback.length&&(this._popularQuestionsData=this.config.popularQuestions.fallback,this._renderPopularQuestions(this.config.popularQuestions.fallback),this._showPopularQuestions());try{var t=await this._fetchPopularQuestions();return t&&0<t.length&&(this._popularQuestionsData=t,this._setCachedPopularQuestions(t),this._popularQuestionsVisible)&&this._renderPopularQuestions(t),t}catch(e){return console.warn("LumifyWidget: Failed to fetch popular questions:",e),this.config.popularQuestions.fallback}}async _fetchPopularQuestions(){var e,t=this._getPopularQuestionsEndpoint(),t=await fetch(`${t}?app_id=${encodeURIComponent(this.config.appId)}&limit=`+this.config.popularQuestions.maxDisplay,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.config.apiKey}});if(t.ok)return(e=await t.json()).success&&e.questions?(e.cache_hint&&(this.config.popularQuestions.cacheTTL=e.cache_hint),e.questions):[];throw new Error("HTTP "+t.status)}_getPopularQuestionsEndpoint(){return this.config.apiEndpoint.includes("/search.php")?this.config.apiEndpoint.replace("/search.php","/popular-questions.php"):this.config.apiEndpoint.substring(0,this.config.apiEndpoint.lastIndexOf("/"))+"/popular-questions.php"}_getCachedPopularQuestions(){if("none"===this.config.popularQuestions.cacheStrategy)return null;var e="sessionStorage"===this.config.popularQuestions.cacheStrategy?sessionStorage:localStorage,t="lumify_popular_"+this.config.appId;try{var i=e.getItem(t);if(i){var o=JSON.parse(i),a=Date.now()/1e3;if(o.timestamp&&a-o.timestamp<this.config.popularQuestions.cacheTTL)return o.questions;e.removeItem(t)}return null}catch(e){return null}}_setCachedPopularQuestions(e){if("none"!==this.config.popularQuestions.cacheStrategy){var t="sessionStorage"===this.config.popularQuestions.cacheStrategy?sessionStorage:localStorage,i="lumify_popular_"+this.config.appId;try{t.setItem(i,JSON.stringify({questions:e,timestamp:Date.now()/1e3}))}catch(e){console.warn("LumifyWidget: Failed to cache popular questions:",e)}}}_renderPopularQuestions(e){var t=this.elements.results;t&&(t=t.querySelector(".lumify-widget-popular"))&&(t=t.querySelector(".lumify-widget-popular-list"))&&(t.innerHTML=e.map(e=>`
                <li class="lumify-widget-popular-item" data-question="${l(e)}">${l(e)}</li>
            `).join(""),t.querySelectorAll(".lumify-widget-popular-item").forEach(t=>{t.addEventListener("click",()=>{var e=t.dataset.question;this._selectPopularQuestion(e)})}))}_showPopularQuestions(){var e=this.elements.results?.querySelector(".lumify-widget-popular");e&&0<this._popularQuestionsData?.length&&(e.classList.remove("lw-hidden"),this._popularQuestionsVisible=!0,e=this.elements.results?.querySelector(".lumify-widget-empty"))&&(e.style.display="none")}_hidePopularQuestions(){var e=this.elements.results?.querySelector(".lumify-widget-popular");e&&(e.classList.add("lw-hidden"),this._popularQuestionsVisible=!1)}_selectPopularQuestion(e){this.elements.input&&(this.elements.input.value=e,this.elements.input.focus()),this._hidePopularQuestions(),this._performSearch()}destroy(){this.currentSearch&&this.currentSearch.abort(),this.elements.root&&this.elements.root.remove();var e=document.getElementById("lumify-widget-styles");e&&e.remove(),document.body.style.overflow=""}}function i(e){var t=e.accentColor;return`
/* Lumify Widget Styles - Scoped to .lumify-widget-* classes */

/* CSS Variables */
.lumify-widget-root {
    --lw-accent: ${t};
    --lw-accent-hover: ${((e,t)=>{let i=e.replace("#",""),o=(3===i.length&&(i=i.split("").map(e=>e+e).join("")),parseInt(i,16)),a=(o>>16)+t,r=(o>>8&255)+t,n=(255&o)+t;return a=Math.max(0,Math.min(255,a)),r=Math.max(0,Math.min(255,r)),n=Math.max(0,Math.min(255,n)),"#"+((1<<24)+(a<<16)+(r<<8)+n).toString(16).slice(1)})(t,-15)};
    --lw-z-index: ${e.zIndex};
    
    /* Light theme (default) */
    --lw-bg: #ffffff;
    --lw-bg-secondary: #f9fafb;
    --lw-bg-tertiary: #f3f4f6;
    --lw-text: #1f2937;
    --lw-text-muted: #6b7280;
    --lw-text-light: #9ca3af;
    --lw-border: #e5e7eb;
    --lw-border-focus: #d1d5db;
    --lw-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    --lw-shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --lw-overlay: rgba(0, 0, 0, 0.5);
}

/* Dark theme */
.lumify-widget-root.lw-theme-dark {
    --lw-bg: #1f2937;
    --lw-bg-secondary: #374151;
    --lw-bg-tertiary: #4b5563;
    --lw-text: #f9fafb;
    --lw-text-muted: #d1d5db;
    --lw-text-light: #9ca3af;
    --lw-border: #4b5563;
    --lw-border-focus: #6b7280;
    --lw-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    --lw-overlay: rgba(0, 0, 0, 0.7);
}

/* Reset for widget elements */
.lumify-widget-root,
.lumify-widget-root * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ===================== Floating Button ===================== */

.lumify-widget-button {
    position: fixed;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-width: 56px;
    height: 56px;
    padding: 0 20px;
    background: var(--lw-accent);
    color: #ffffff;
    border: none;
    border-radius: 28px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    box-shadow: var(--lw-shadow-sm), 0 0 0 0 rgba(99, 102, 241, 0.4);
    transition: all 0.2s ease;
    z-index: var(--lw-z-index);
    outline: none;
}

.lumify-widget-button:hover {
    background: var(--lw-accent-hover);
    transform: scale(1.05);
    box-shadow: var(--lw-shadow), 0 0 0 0 rgba(99, 102, 241, 0.4);
}

.lumify-widget-button:active {
    transform: scale(0.98);
}

.lumify-widget-button:focus-visible {
    box-shadow: var(--lw-shadow-sm), 0 0 0 3px rgba(99, 102, 241, 0.4);
}

.lumify-widget-button.lw-icon-only {
    width: 56px;
    padding: 0;
}

.lumify-widget-button svg {
    flex-shrink: 0;
}

/* Position variants */
.lumify-widget-button.lw-bottom-right { bottom: 24px; right: 24px; }
.lumify-widget-button.lw-bottom-left { bottom: 24px; left: 24px; }
.lumify-widget-button.lw-top-right { top: 24px; right: 24px; }
.lumify-widget-button.lw-top-left { top: 24px; left: 24px; }

/* ===================== Modal Overlay ===================== */

.lumify-widget-overlay {
    position: fixed;
    inset: 0;
    background: var(--lw-overlay);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    z-index: calc(var(--lw-z-index) + 1);
}

.lumify-widget-overlay.lw-open {
    opacity: 1;
    visibility: visible;
}

/* ===================== Modal Container ===================== */

.lumify-widget-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    width: 90%;
    max-width: 640px;
    max-height: 85vh;
    background: var(--lw-bg);
    border-radius: 16px;
    box-shadow: var(--lw-shadow);
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    z-index: calc(var(--lw-z-index) + 2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.lumify-widget-modal.lw-open {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
}

/* ===================== Modal Header ===================== */

.lumify-widget-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--lw-border);
    background: var(--lw-bg-secondary);
}

.lumify-widget-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--lw-text);
}

.lumify-widget-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: transparent;
    border: none;
    border-radius: 8px;
    color: var(--lw-text-muted);
    cursor: pointer;
    transition: all 0.15s ease;
}

.lumify-widget-close:hover {
    background: var(--lw-bg-tertiary);
    color: var(--lw-text);
}

/* ===================== Search Form ===================== */

.lumify-widget-search {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    background: var(--lw-bg);
    border-bottom: 1px solid var(--lw-border);
}

.lumify-widget-input {
    flex: 1;
    padding: 12px 16px;
    background: var(--lw-bg-secondary);
    border: 1px solid var(--lw-border);
    border-radius: 10px;
    font-size: 15px;
    color: var(--lw-text);
    outline: none;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.lumify-widget-input::placeholder {
    color: var(--lw-text-light);
}

.lumify-widget-input:focus {
    border-color: var(--lw-accent);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.lumify-widget-submit {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    background: var(--lw-accent);
    border: none;
    border-radius: 10px;
    color: #ffffff;
    cursor: pointer;
    transition: background 0.15s ease, transform 0.15s ease;
    flex-shrink: 0;
}

.lumify-widget-submit:hover {
    background: var(--lw-accent-hover);
}

.lumify-widget-submit:active {
    transform: scale(0.95);
}

.lumify-widget-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* ===================== Results Area ===================== */

.lumify-widget-results {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    min-height: 200px;
    max-height: 400px;
}

.lumify-widget-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: var(--lw-text-muted);
    text-align: center;
}

.lumify-widget-empty-icon {
    margin-bottom: 12px;
    opacity: 0.5;
}

.lumify-widget-empty-text {
    font-size: 14px;
}

/* Loading state */
.lumify-widget-loading {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 0;
    color: var(--lw-text-muted);
    font-size: 14px;
}

.lumify-widget-loading svg {
    color: var(--lw-accent);
}

/* Answer text */
.lumify-widget-answer {
    font-size: 15px;
    line-height: 1.7;
    color: var(--lw-text);
}

.lumify-widget-answer p {
    margin-bottom: 12px;
}

.lumify-widget-answer p:last-child {
    margin-bottom: 0;
}

/* Confidence score */
.lumify-widget-confidence {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid var(--lw-border);
    font-size: 12px;
    color: var(--lw-text-light);
}

/* Structural CTA - Call-to-action links */
.lumify-widget-cta {
    margin-top: 16px;
    padding-top: 14px;
    border-top: 1px solid var(--lw-border);
}

.lumify-widget-cta-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--lw-cta-color, #7c3aed);
    font-size: calc(var(--lw-font-size, 15px) * 1.05);
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
}

.lumify-widget-cta-link:hover {
    color: var(--lw-cta-hover, #6d28d9);
}

.lumify-widget-cta-link:hover .lumify-widget-cta-badge {
    background: var(--lw-cta-hover, #6d28d9);
    transform: translateX(2px);
}

.lumify-widget-cta-text {
    text-decoration: underline;
    text-underline-offset: 2px;
}

.lumify-widget-cta-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: var(--lw-cta-color, #7c3aed);
    border-radius: 50%;
    transition: all 0.2s ease;
}

.lumify-widget-cta-badge svg {
    width: 12px;
    height: 12px;
    color: white;
}

/* Dark theme CTA */
.lw-theme-dark .lumify-widget-cta-link {
    color: var(--lw-cta-color, #a78bfa);
}

.lw-theme-dark .lumify-widget-cta-link:hover {
    color: var(--lw-cta-hover, #c4b5fd);
}

.lw-theme-dark .lumify-widget-cta-badge {
    background: var(--lw-cta-color, #a78bfa);
}

.lw-theme-dark .lumify-widget-cta-link:hover .lumify-widget-cta-badge {
    background: var(--lw-cta-hover, #c4b5fd);
}

/* Error state */
.lumify-widget-error {
    padding: 16px;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 10px;
    color: #dc2626;
    font-size: 14px;
}

.lumify-widget-error a {
    color: var(--lw-accent);
    text-decoration: underline;
}

/* No results */
.lumify-widget-no-results {
    padding: 20px 0;
    text-align: center;
    color: var(--lw-text-muted);
    font-size: 14px;
}

/* Popular Questions */
.lumify-widget-popular {
    padding: 16px 0 0;
}

.lumify-widget-popular.lw-hidden {
    display: none;
}

.lumify-widget-popular-header {
    font-size: 13px;
    font-weight: 500;
    color: var(--lw-text-muted);
    margin-bottom: 12px;
}

.lumify-widget-popular-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.lumify-widget-popular-item {
    padding: 12px 14px;
    background: var(--lw-bg-secondary);
    border: 1px solid var(--lw-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 14px;
    color: var(--lw-text);
    line-height: 1.4;
}

.lumify-widget-popular-item:hover {
    background: var(--lw-bg-tertiary);
    border-color: var(--lw-accent);
    color: var(--lw-accent);
    transform: translateX(4px);
}

.lumify-widget-popular-item:active {
    transform: translateX(2px);
}

/* Citation chips */
.lumify-widget-citation {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.4em;
    height: 1.4em;
    padding: 0 0.4em;
    margin: 0 2px;
    background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
    border: 1px solid #c7d2fe;
    color: #6366f1;
    font-size: 0.75em;
    font-weight: 600;
    text-decoration: none;
    border-radius: 4px;
    vertical-align: middle;
    transition: all 0.15s ease;
    z-index: 1;
}

.lumify-widget-citation:hover {
    background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    border-color: #a5b4fc;
    color: #4f46e5;
    transform: translateY(-1px);
}

.lw-theme-dark .lumify-widget-citation {
    background: linear-gradient(135deg, #3730a3 0%, #4338ca 100%);
    border-color: #6366f1;
    color: #e0e7ff;
}

.lw-theme-dark .lumify-widget-citation:hover {
    background: linear-gradient(135deg, #4338ca 0%, #4f46e5 100%);
    border-color: #818cf8;
    color: #ffffff;
}

/* Citation tooltip */
.lumify-widget-citation:hover {
    z-index: 1001;
}

.lumify-widget-citation-tooltip {
    position: absolute;
    top: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    min-width: 220px;
    max-width: 300px;
    padding: 10px 12px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.15s ease, visibility 0.15s ease;
    z-index: 1002;
    text-align: left;
    white-space: normal;
    font-weight: normal;
    font-size: 12px;
    line-height: 1.4;
}

/* Tooltip arrow pointing up */
.lumify-widget-citation-tooltip::after {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-bottom-color: #ffffff;
}

.lumify-widget-citation-tooltip::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 7px solid transparent;
    border-bottom-color: #e5e7eb;
}

/* Show tooltip on hover */
.lumify-widget-citation:hover .lumify-widget-citation-tooltip {
    opacity: 1;
    visibility: visible;
}

/* Tooltip flipped above citation */
.lumify-widget-citation-tooltip.tooltip-above::after,
.lumify-widget-citation-tooltip.tooltip-above::before {
    bottom: auto;
    top: 100%;
}
.lumify-widget-citation-tooltip.tooltip-above::after {
    border-bottom-color: transparent;
    border-top-color: #ffffff;
}
.lumify-widget-citation-tooltip.tooltip-above::before {
    border-bottom-color: transparent;
    border-top-color: #e5e7eb;
}

/* Tooltip content layout */
.lumify-widget-citation-tooltip-content {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.lumify-widget-citation-favicon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    border-radius: 4px;
    overflow: hidden;
}

.lumify-widget-citation-favicon img {
    width: 16px;
    height: 16px;
    object-fit: contain;
}

.lumify-widget-citation-info {
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

.lumify-widget-citation-title {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: #1f2937;
    line-height: 1.3;
    margin-bottom: 2px;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}

.lumify-widget-citation-url {
    display: block;
    font-size: 11px;
    color: #6b7280;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Dark theme tooltip */
.lw-theme-dark .lumify-widget-citation-tooltip {
    background: #1f2937;
    border-color: #374151;
}

.lw-theme-dark .lumify-widget-citation-tooltip::after {
    border-bottom-color: #1f2937;
}

.lw-theme-dark .lumify-widget-citation-tooltip::before {
    border-bottom-color: #374151;
}

.lw-theme-dark .lumify-widget-citation-tooltip.tooltip-above::after {
    border-bottom-color: transparent;
    border-top-color: #1f2937;
}
.lw-theme-dark .lumify-widget-citation-tooltip.tooltip-above::before {
    border-bottom-color: transparent;
    border-top-color: #374151;
}

.lw-theme-dark .lumify-widget-citation-favicon {
    background: #374151;
}

.lw-theme-dark .lumify-widget-citation-title {
    color: #f9fafb;
}

.lw-theme-dark .lumify-widget-citation-url {
    color: #9ca3af;
}

.lw-theme-dark .lumify-widget-error {
    background: #451a1a;
    border-color: #7f1d1d;
    color: #fca5a5;
}

/* ===================== Footer / Branding ===================== */

.lumify-widget-footer {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 20px;
    border-top: 1px solid var(--lw-border);
    background: var(--lw-bg-secondary);
}

.lumify-widget-branding {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--lw-text-light);
    text-decoration: none;
}

.lumify-widget-branding:hover .lumify-widget-branding-link {
    text-decoration: underline;
}

.lumify-widget-branding-link {
    color: var(--lw-accent);
    font-weight: 500;
}

/* ===================== Inline Mode ===================== */

.lumify-widget-inline {
    width: 100%;
    background: var(--lw-bg);
    border: 1px solid var(--lw-border);
    border-radius: 12px;
    overflow: hidden;
}

.lumify-widget-inline .lumify-widget-search {
    border-bottom: none;
}

.lumify-widget-inline .lumify-widget-results {
    border-top: 1px solid var(--lw-border);
    max-height: 500px;
}

.lumify-widget-inline .lumify-widget-results:empty {
    display: none;
    border-top: none;
}

/* ===================== Keyboard Shortcut Hint ===================== */

.lumify-widget-shortcut {
    display: none;
    align-items: center;
    gap: 4px;
    margin-left: auto;
    padding: 4px 8px;
    background: var(--lw-bg-tertiary);
    border-radius: 6px;
    font-size: 11px;
    color: var(--lw-text-light);
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
}

@media (min-width: 768px) {
    .lumify-widget-shortcut {
        display: flex;
    }
}

/* ===================== Mobile Responsive ===================== */

@media (max-width: 640px) {
    .lumify-widget-button {
        width: 52px;
        height: 52px;
        min-width: 52px;
        padding: 0;
        border-radius: 26px;
    }
    
    .lumify-widget-button .lw-button-text {
        display: none;
    }
    
    .lumify-widget-modal {
        width: 100%;
        max-width: none;
        max-height: 100%;
        height: 100%;
        border-radius: 0;
        top: 0;
        left: 0;
        transform: translateY(100%);
    }
    
    .lumify-widget-modal.lw-open {
        transform: translateY(0);
    }
    
    .lumify-widget-results {
        max-height: none;
        flex: 1;
    }
}

/* ===================== Reduced Motion ===================== */

@media (prefers-reduced-motion: reduce) {
    .lumify-widget-button,
    .lumify-widget-overlay,
    .lumify-widget-modal,
    .lumify-widget-input,
    .lumify-widget-submit,
    .lumify-widget-close,
    .lumify-widget-citation {
        transition: none;
    }
}

/* ===================== Print ===================== */

@media print {
    .lumify-widget-button,
    .lumify-widget-overlay,
    .lumify-widget-modal {
        display: none !important;
    }
}
`}function l(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}function n(){return 0<=navigator.platform.toUpperCase().indexOf("MAC")?"âŒ˜K":"Ctrl+K"}function a(e,t,i="_blank"){var o=l(t.url||""),a=l(t.title||t.page_title||(e=>{if(!e)return"Source";try{return new URL(e).hostname.replace(/^www\./,"")}catch(e){return"Source"}})(t.url)),r=(t=>{if(!t)return"";try{var i=new URL(t);let e=i.pathname;return 30<e.length&&(e=e.substring(0,27)+"..."),i.hostname+e}catch(e){return 40<t.length?t.substring(0,37)+"...":t}})(t.url);return`<a href="${o}" target="${i}" ${"_blank"===i?'rel="noopener noreferrer"':""} class="lumify-widget-citation" data-citation="${e}">
            ${e}
            <span class="lumify-widget-citation-tooltip">
                <span class="lumify-widget-citation-tooltip-content">
                    <span class="lumify-widget-citation-favicon">
                        <img src="${(e=>{if(!e)return"";try{return`https://www.google.com/s2/favicons?domain=${new URL(e).hostname}&sz=32`}catch(e){return""}})(t.url)}" alt="" onerror="this.style.display='none'">
                    </span>
                    <span class="lumify-widget-citation-info">
                        <span class="lumify-widget-citation-title">${a}</span>
                        <span class="lumify-widget-citation-url">${r}</span>
                    </span>
                </span>
            </span>
        </a>`}function e(){var i=document.querySelectorAll('script[src*="lumify-widget"]'),i=i[i.length-1];if(i){var o=i.src||"";let e="",t=(o&&(o=new URL(o),e=o.origin),[]);try{var a=i.dataset.popularQuestionsFallback||i.getAttribute("data-popular-questions-fallback");a&&(t=JSON.parse(a))}catch(e){console.warn("LumifyWidget: Invalid popular-questions-fallback JSON:",e)}o={apiKey:i.dataset.apiKey||i.getAttribute("data-api-key"),appId:i.dataset.appId||i.getAttribute("data-app-id"),mode:i.dataset.mode||"floating",position:i.dataset.position||"bottom-right",theme:i.dataset.theme||"auto",accentColor:i.dataset.accentColor||"#6366f1",buttonText:i.dataset.buttonText||"",buttonIcon:i.dataset.buttonIcon||"search",placeholder:i.dataset.placeholder||"Ask anything...",keyboardShortcut:"false"!==i.dataset.keyboardShortcut,showBranding:"false"!==i.dataset.showBranding,zIndex:parseInt(i.dataset.zIndex)||9999,emptyText:i.dataset.emptyText||"Ask a question to get started",modalTitle:i.dataset.modalTitle||"Search",triggerSelector:i.dataset.triggerSelector,containerSelector:i.dataset.containerSelector,ctaTarget:i.dataset.ctaTarget||"_self",baseUrl:e,popularQuestions:{enabled:"true"===i.dataset.popularQuestions,maxDisplay:parseInt(i.dataset.popularQuestionsMax)||5,cacheStrategy:i.dataset.popularQuestionsCache||"localStorage",cacheTTL:parseInt(i.dataset.popularQuestionsTtl)||86400,fallback:t}};o.apiKey?o.appId?(window.LumifyWidget=new s(o),window.LumifyWidget._initialized=!0):console.error("LumifyWidget: data-app-id is required"):console.error("LumifyWidget: data-api-key is required")}else console.error("LumifyWidget: Script tag not found")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}})();